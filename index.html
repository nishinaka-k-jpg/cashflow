import { useState } from "react";

// å·®é¡è‡ªå‹•è¨ˆç®—ã™ã‚‹é …ç›®
const diffItems = [
  { id: "ar",  label: "å£²æ›é‡‘",   sign: -1, hint: "å¢—åŠ ã¯ãƒã‚¤ãƒŠã‚¹" },
  { id: "inv", label: "æ£šå¸è³‡ç”£", sign: -1, hint: "å¢—åŠ ã¯ãƒã‚¤ãƒŠã‚¹" },
  { id: "ap",  label: "è²·æ›é‡‘",   sign:  1, hint: "å¢—åŠ ã¯ãƒ—ãƒ©ã‚¹" },
];

const sections = [
  {
    id: "operating", label: "â… ï¼å–¶æ¥­æ´»å‹•ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼",
    color: "bg-blue-600", bg: "bg-blue-50",
    items: [
      { id: "net_income",      label: "ç¨å¼•å‰å½“æœŸç´”åˆ©ç›Š", sign: 1 },
      { id: "depreciation",    label: "æ¸›ä¾¡å„Ÿå´è²»",       sign: 1 },
      { id: "tax_paid",        label: "æ³•äººç¨ç­‰ã®æ”¯æ‰•é¡", sign: -1 },
      { id: "other_operating", label: "ãã®ä»–ï¼ˆå–¶æ¥­ï¼‰",   sign: 1 },
    ],
  },
  {
    id: "investing", label: "â…¡ï¼æŠ•è³‡æ´»å‹•ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼",
    color: "bg-green-600", bg: "bg-green-50",
    items: [
      { id: "capex",           label: "æœ‰å½¢å›ºå®šè³‡ç”£ã®å–å¾—ï¼ˆãƒã‚¤ãƒŠã‚¹å…¥åŠ›ï¼‰",   sign: 1 },
      { id: "asset_sale",      label: "æœ‰å½¢å›ºå®šè³‡ç”£ã®å£²å´",                   sign: 1 },
      { id: "investment_buy",  label: "æŠ•è³‡æœ‰ä¾¡è¨¼åˆ¸ã®å–å¾—ï¼ˆãƒã‚¤ãƒŠã‚¹å…¥åŠ›ï¼‰",   sign: 1 },
      { id: "investment_sell", label: "æŠ•è³‡æœ‰ä¾¡è¨¼åˆ¸ã®å£²å´",                   sign: 1 },
      { id: "other_investing", label: "ãã®ä»–ï¼ˆæŠ•è³‡ï¼‰",                       sign: 1 },
    ],
  },
  {
    id: "financing", label: "â…¢ï¼è²¡å‹™æ´»å‹•ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼",
    color: "bg-purple-600", bg: "bg-purple-50",
    items: [
      { id: "dividend",        label: "é…å½“é‡‘ã®æ”¯æ‰•é¡ï¼ˆãƒã‚¤ãƒŠã‚¹å…¥åŠ›ï¼‰", sign: 1 },
      { id: "treasury_stock",  label: "è‡ªç¤¾æ ªå–å¾—ï¼ˆãƒã‚¤ãƒŠã‚¹å…¥åŠ›ï¼‰",     sign: 1 },
      { id: "lease_payment",   label: "ãƒªãƒ¼ã‚¹å‚µå‹™ã®è¿”æ¸ˆï¼ˆãƒã‚¤ãƒŠã‚¹å…¥åŠ›ï¼‰", sign: 1 },
      { id: "other_financing", label: "ãã®ä»–ï¼ˆè²¡å‹™ï¼‰",                 sign: 1 },
    ],
  },
];

const parseNum = (s) => { const n = parseFloat(String(s ?? "").replace(/,/g, "")); return isNaN(n) ? 0 : n; };
const fmt = (v) => Number(v).toLocaleString("ja-JP");
const colorClass = (v) => v > 0 ? "text-blue-700 font-bold" : v < 0 ? "text-red-600 font-bold" : "text-gray-700 font-bold";

function NumInput({ value, onChange, placeholder = "0", className = "" }) {
  const [focused, setFocused] = useState(false);
  const raw = String(value ?? "");
  const display = focused ? raw : (raw === "" || raw === "-") ? raw : (isNaN(parseFloat(raw.replace(/,/g,""))) ? raw : parseFloat(raw.replace(/,/g,"")).toLocaleString("ja-JP"));
  return (
    <input type="text" inputMode="numeric"
      className={`border rounded px-2 py-1 w-full text-right text-sm ${className}`}
      value={display} placeholder={placeholder}
      onFocus={() => setFocused(true)} onBlur={() => setFocused(false)}
      onChange={e => { const v = e.target.value.replace(/,/g,""); if (v===""||v==="-"||/^-?\d*\.?\d*$/.test(v)) onChange(v); }}
    />
  );
}

function analyze({ opTotal, invTotal, cashEnd, values, diffVals }) {
  const fcf = opTotal + invTotal;
  const netIncome = parseNum(values.net_income);
  const arDiff   = (parseNum(diffVals.ar_curr)  - parseNum(diffVals.ar_prev))  * -1;
  const invDiff  = (parseNum(diffVals.inv_curr) - parseNum(diffVals.inv_prev)) * -1;
  const monthlyRevenue = parseNum(values.monthly_revenue);
  const comments = [];

  if (opTotal > 0) {
    if (netIncome > 0 && opTotal >= netIncome)
      comments.push({ level: "good", title: "å–¶æ¥­CFï¼šå„ªè‰¯", body: `æœ¬æ¥­ã§${fmt(opTotal)}å††ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰µå‡ºã—ã¦ãŠã‚Šã€åˆ©ç›Šã‚’ã—ã£ã‹ã‚Šç¾é‡‘åŒ–ã§ãã¦ã„ã¾ã™ã€‚` });
    else if (netIncome > 0 && opTotal < netIncome)
      comments.push({ level: "warn", title: "å–¶æ¥­CFï¼šè¦æ³¨æ„ï¼ˆåˆ©ç›Šã¨ã®ä¹–é›¢ï¼‰", body: `åˆ©ç›Šï¼ˆ${fmt(netIncome)}å††ï¼‰ã«å¯¾ã—ã¦å–¶æ¥­CFï¼ˆ${fmt(opTotal)}å††ï¼‰ãŒä½ããªã£ã¦ã„ã¾ã™ã€‚å£²æ›é‡‘ã®å›åé…ã‚Œã‚„åœ¨åº«å¢—åŠ ãŒåŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚` });
    else
      comments.push({ level: "good", title: "å–¶æ¥­CFï¼šãƒ—ãƒ©ã‚¹", body: `å–¶æ¥­æ´»å‹•ã§${fmt(opTotal)}å††ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºä¿ã§ãã¦ã„ã¾ã™ã€‚` });
  } else {
    comments.push({ level: "bad", title: "å–¶æ¥­CFï¼šå±é™ºï¼ˆãƒã‚¤ãƒŠã‚¹ï¼‰", body: `æœ¬æ¥­ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒ${fmt(opTotal)}å††æµå‡ºã—ã¦ã„ã¾ã™ã€‚åç›Šæ§‹é€ ã®è¦‹ç›´ã—ãŒæ€¥å‹™ã§ã™ã€‚` });
  }

  if (arDiff < 0)  comments.push({ level: "warn", title: "å£²æ›é‡‘ãŒå¢—åŠ ", body: `å£²æ›é‡‘ãŒ${fmt(Math.abs(arDiff))}å††å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚å›åã‚µã‚¤ã‚¯ãƒ«ã®ç¢ºèªã¨ç£ä¿ƒå¼·åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚` });
  if (invDiff < 0) comments.push({ level: "warn", title: "æ£šå¸è³‡ç”£ãŒå¢—åŠ ", body: `åœ¨åº«ãŒ${fmt(Math.abs(invDiff))}å††å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚éå‰°åœ¨åº«ã«ãªã£ã¦ã„ãªã„ã‹ç¢ºèªãŒå¿…è¦ã§ã™ã€‚` });

  if (fcf > 0)
    comments.push({ level: "good", title: "ãƒ•ãƒªãƒ¼CFï¼šãƒ—ãƒ©ã‚¹ï¼ˆå¥å…¨ï¼‰", body: `FCFã¯${fmt(fcf)}å††ã®ãƒ—ãƒ©ã‚¹ã§ã™ã€‚æŠ•è³‡ã‚’è¡Œã„ãªãŒã‚‰ã‚‚ä½™å‰°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç”Ÿã¾ã‚Œã¦ãŠã‚Šã€è²¡å‹™çš„ã«å®‰å®šã—ãŸçŠ¶æ…‹ã§ã™ã€‚` });
  else if (fcf < 0 && opTotal > 0)
    comments.push({ level: "info", title: "ãƒ•ãƒªãƒ¼CFï¼šãƒã‚¤ãƒŠã‚¹ï¼ˆç©æ¥µæŠ•è³‡ä¸­ï¼‰", body: `FCFã¯${fmt(fcf)}å††ã®ãƒã‚¤ãƒŠã‚¹ã§ã™ãŒã€å–¶æ¥­CFã¯ãƒ—ãƒ©ã‚¹ã®ãŸã‚æŠ•è³‡å…ˆè¡Œã®çŠ¶æ…‹ã§ã™ã€‚æŠ•è³‡åŠ¹æœã®æ¤œè¨¼ã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚` });
  else
    comments.push({ level: "bad", title: "ãƒ•ãƒªãƒ¼CFï¼šè¦è­¦æˆ’", body: `å–¶æ¥­CFãƒ»æŠ•è³‡CFå…±ã«ãƒã‚¤ãƒŠã‚¹ã§ã€FCFã¯${fmt(fcf)}å††ã§ã™ã€‚è³‡é‡‘ã®èª¿é”æ‰‹æ®µã‚’æ—©æ€¥ã«æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚` });

  if (monthlyRevenue > 0) {
    const months = cashEnd / monthlyRevenue;
    if (months >= 3 && months <= 6)
      comments.push({ level: "good", title: "ç¾é‡‘æ®‹é«˜ï¼šé©æ­£æ°´æº–", body: `æœŸæœ«ç¾é‡‘æ®‹é«˜ã¯æœˆå•†ã®ç´„${months.toFixed(1)}ãƒ¶æœˆåˆ†ï¼ˆ${fmt(cashEnd)}å††ï¼‰ã§ã€æ¨å¥¨æ°´æº–ï¼ˆ3ã€œ6ãƒ¶æœˆï¼‰å†…ã§ã™ã€‚` });
    else if (months < 3)
      comments.push({ level: "bad",  title: "ç¾é‡‘æ®‹é«˜ï¼šä¸è¶³æ°—å‘³", body: `æœŸæœ«ç¾é‡‘æ®‹é«˜ã¯æœˆå•†ã®ç´„${months.toFixed(1)}ãƒ¶æœˆåˆ†ã§ã™ã€‚ç·Šæ€¥æ™‚ã®å‚™ãˆã¨ã—ã¦æœ€ä½3ãƒ¶æœˆåˆ†ã®ç¢ºä¿ã‚’æ¨å¥¨ã—ã¾ã™ã€‚` });
    else
      comments.push({ level: "info", title: "ç¾é‡‘æ®‹é«˜ï¼šä½™å‰°ã‚ã‚Š", body: `æœŸæœ«ç¾é‡‘æ®‹é«˜ã¯æœˆå•†ã®ç´„${months.toFixed(1)}ãƒ¶æœˆåˆ†ã¨æ½¤æ²¢ã§ã™ã€‚è¿½åŠ æŠ•è³‡ã‚„æ ªä¸»é‚„å…ƒã®æ¤œè¨ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚` });
  }

  const goodCount = [opTotal > 0, fcf > 0, cashEnd > 0].filter(Boolean).length;
  if (goodCount === 3) comments.push({ level: "good", title: "ç·åˆåˆ¤å®šï¼šå„ªè‰¯", body: "å–¶æ¥­CFãƒ»FCFãƒ»ç¾é‡‘æ®‹é«˜ã®å…¨ã¦ãŒå¥å…¨ãªæ°´æº–ã§ã™ã€‚ç¾åœ¨ã®çµŒå–¶çŠ¶æ…‹ã‚’ç¶­æŒã—ã¤ã¤ã€æˆé•·æŠ•è³‡ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ¤œè¨ã§ãã‚‹å±€é¢ã§ã™ã€‚" });
  else if (goodCount === 2) comments.push({ level: "warn", title: "ç·åˆåˆ¤å®šï¼šæ¦‚ã­è‰¯å¥½ãƒ»ä¸€éƒ¨è¦æ³¨æ„", body: "å…¨ä½“çš„ã«ã¯å®‰å®šã—ã¦ã„ã¾ã™ãŒã€ä¸€éƒ¨ã«æ”¹å–„ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šè¨˜ã®è­¦å‘Šé …ç›®ã‚’é‡ç‚¹çš„ã«å¯¾ç­–ã—ã¦ãã ã•ã„ã€‚" });
  else comments.push({ level: "bad", title: "ç·åˆåˆ¤å®šï¼šè¦æ”¹å–„", body: "è¤‡æ•°ã®æŒ‡æ¨™ã§å•é¡ŒãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚çµŒå–¶ä¼šè­°ã§å„ªå…ˆèª²é¡Œã‚’æ•´ç†ã—ã€æ—©æœŸå¯¾ç­–ã‚’è¬›ã˜ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚" });

  let scoreOp=0, scoreFcf=0, scoreAr=0, scoreInv=0, scoreCash=0;
  if (opTotal > 0) { if (netIncome > 0 && opTotal >= netIncome) scoreOp=30; else scoreOp=20; }
  if (fcf > 0) scoreFcf=30; else if (fcf < 0 && opTotal > 0) scoreFcf=10;
  if (arDiff >= 0)  scoreAr=20;
  if (invDiff >= 0) scoreInv=10;
  if (monthlyRevenue > 0) { const m=cashEnd/monthlyRevenue; if(m>=3&&m<=6) scoreCash=10; else if(m>=1) scoreCash=5; } else if (cashEnd>0) scoreCash=5;
  const score = scoreOp+scoreFcf+scoreAr+scoreInv+scoreCash;
  const breakdown = [
    { label:"å–¶æ¥­CF",   got:scoreOp,   max:30 },
    { label:"ãƒ•ãƒªãƒ¼CF", got:scoreFcf,  max:30 },
    { label:"å£²æ›é‡‘",   got:scoreAr,   max:20 },
    { label:"æ£šå¸è³‡ç”£", got:scoreInv,  max:10 },
    { label:"ç¾é‡‘æ®‹é«˜", got:scoreCash, max:10 },
  ];
  return { comments, fcf, score, breakdown };
}

const levelStyle = {
  good: { bg:"bg-green-50 border-green-300", icon:"âœ…", title:"text-green-700" },
  warn: { bg:"bg-yellow-50 border-yellow-300", icon:"âš ï¸", title:"text-yellow-700" },
  bad:  { bg:"bg-red-50 border-red-300", icon:"ğŸ”´", title:"text-red-700" },
  info: { bg:"bg-blue-50 border-blue-300", icon:"ğŸ’¡", title:"text-blue-700" },
};

const scoreBreakdownDef = [
  { item:"å–¶æ¥­CF", max:"30ç‚¹", rules:[{pt:"30ç‚¹",cond:"ãƒ—ãƒ©ã‚¹ã‹ã¤åˆ©ç›Šä»¥ä¸Šã®CFã‚’ç¢ºä¿"},{pt:"20ç‚¹",cond:"ãƒ—ãƒ©ã‚¹ã ãŒåˆ©ç›Šã‚’ä¸‹å›ã£ã¦ã„ã‚‹"},{pt:"0ç‚¹",cond:"ãƒã‚¤ãƒŠã‚¹ï¼ˆæœ¬æ¥­ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæµå‡ºï¼‰"}]},
  { item:"ãƒ•ãƒªãƒ¼CF", max:"30ç‚¹", rules:[{pt:"30ç‚¹",cond:"ãƒ—ãƒ©ã‚¹ï¼ˆæŠ•è³‡å¾Œã‚‚ä½™å‰°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Šï¼‰"},{pt:"10ç‚¹",cond:"ãƒã‚¤ãƒŠã‚¹ã ãŒå–¶æ¥­CFã¯ãƒ—ãƒ©ã‚¹ï¼ˆæŠ•è³‡å…ˆè¡Œï¼‰"},{pt:"0ç‚¹",cond:"å–¶æ¥­CFãƒ»æŠ•è³‡CFå…±ã«ãƒã‚¤ãƒŠã‚¹"}]},
  { item:"å£²æ›é‡‘", max:"20ç‚¹", rules:[{pt:"20ç‚¹",cond:"å‰æœŸæ¯”ã§å¢—åŠ ã—ã¦ã„ãªã„ï¼ˆå›åè‰¯å¥½ï¼‰"},{pt:"0ç‚¹",cond:"å‰æœŸæ¯”ã§å¢—åŠ ã—ã¦ã„ã‚‹ï¼ˆå›åé…ã‚Œã®å¯èƒ½æ€§ï¼‰"}]},
  { item:"æ£šå¸è³‡ç”£ï¼ˆåœ¨åº«ï¼‰", max:"10ç‚¹", rules:[{pt:"10ç‚¹",cond:"å‰æœŸæ¯”ã§å¢—åŠ ã—ã¦ã„ãªã„ï¼ˆé©æ­£åœ¨åº«ï¼‰"},{pt:"0ç‚¹",cond:"å‰æœŸæ¯”ã§å¢—åŠ ã—ã¦ã„ã‚‹ï¼ˆéå‰°åœ¨åº«ã®å¯èƒ½æ€§ï¼‰"}]},
  { item:"ç¾é‡‘æ®‹é«˜", max:"10ç‚¹", rules:[{pt:"10ç‚¹",cond:"æœˆå•†ã®3ã€œ6ãƒ¶æœˆåˆ†ï¼ˆé©æ­£æ°´æº–ï¼‰"},{pt:"5ç‚¹",cond:"æœˆå•†ã®1ã€œ3ãƒ¶æœˆåˆ†ã¾ãŸã¯6ãƒ¶æœˆè¶…"},{pt:"0ç‚¹",cond:"æœˆå•†1ãƒ¶æœˆåˆ†æœªæº€ï¼ˆä¸è¶³ï¼‰"}]},
];

export default function App() {
  const [companyName, setCompanyName] = useState("æ ªå¼ä¼šç¤¾â—‹â—‹");
  const [period, setPeriod]           = useState("2024å¹´4æœˆã€œ2025å¹´3æœˆ");
  const [cashStart, setCashStart]     = useState("");
  const [values, setValues]           = useState({});
  const [diffVals, setDiffVals]       = useState({});
  const [tab, setTab]                 = useState("input");

  const set     = (id, v) => setValues(p => ({ ...p, [id]: v }));
  const setDiff = (id, v) => setDiffVals(p => ({ ...p, [id]: v }));

  // å·®é¡è¨ˆç®—ï¼ˆä»ŠæœŸ - å‰æœŸï¼‰Ã— sign
  const diffResult = (item) => {
    const prev = parseNum(diffVals[`${item.id}_prev`]);
    const curr = parseNum(diffVals[`${item.id}_curr`]);
    return (curr - prev) * item.sign;
  };

  const sectionTotal = (sec) => sec.items.reduce((sum, item) => sum + parseNum(values[item.id]) * item.sign, 0);
  const diffTotal    = diffItems.reduce((sum, item) => sum + diffResult(item), 0);
  const opTotal      = sectionTotal(sections[0]) + diffTotal;
  const invTotal     = sectionTotal(sections[1]);
  const finTotal     = sectionTotal(sections[2]);
  const netChange    = opTotal + invTotal + finTotal;
  const cashEnd      = parseNum(cashStart) + netChange;

  const { comments, fcf, score, breakdown } = analyze({ opTotal, invTotal, cashEnd, values, diffVals });

  const exportPDF = () => {
    const w = window.open("", "_blank");
    const sCol = ["#1d4ed8","#16a34a","#7c3aed"];
    const sBg  = ["#eff6ff","#f0fdf4","#faf5ff"];
    const lCol = { good:"#f0fdf4", warn:"#fefce8", bad:"#fef2f2", info:"#eff6ff" };
    const lBd  = { good:"#86efac", warn:"#fde047", bad:"#fca5a5", info:"#93c5fd" };
    let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—æ›¸</title>
    <style>body{font-family:"Hiragino Kaku Gothic Pro",Meiryo,sans-serif;font-size:12px;color:#1f2937;padding:30px;}
    h1{text-align:center;font-size:16px;margin-bottom:4px;}h2{font-size:13px;margin:20px 0 8px;}
    .meta{text-align:center;color:#6b7280;margin-bottom:20px;font-size:11px;}
    table{width:100%;border-collapse:collapse;margin-bottom:16px;}
    th{color:white;padding:6px 10px;text-align:left;font-size:11px;}
    td{padding:5px 10px;border-bottom:1px solid #e5e7eb;}td.r{text-align:right;}
    .sub td{font-weight:bold;}.hl td{background:#fefce8;font-weight:bold;}.fin td{background:#f3f4f6;font-weight:bold;}
    .pos{color:#1d4ed8;}.neg{color:#dc2626;}
    .comment{border-radius:6px;padding:10px 14px;margin-bottom:10px;border:1px solid;}
    .ct{font-weight:bold;margin-bottom:4px;}
    .sb{text-align:center;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:20px;}
    @media print{button{display:none;}}</style></head><body>`;
    html += `<h1>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—æ›¸</h1><div class="meta">${companyName}ã€€å¯¾è±¡æœŸé–“ï¼š${period}</div>`;
    // å–¶æ¥­CF
    html += `<table><thead><tr><th colspan="2" style="background:${sCol[0]}">${sections[0].label}</th></tr></thead><tbody>`;
    sections[0].items.forEach(item => {
      const v = parseNum(values[item.id]) * item.sign;
      html += `<tr><td>${item.label}</td><td class="r ${v>0?"pos":v<0?"neg":""}">${v!==0?fmt(v)+" å††":"â€•"}</td></tr>`;
    });
    diffItems.forEach(item => {
      const v = diffResult(item);
      html += `<tr><td>${item.label}ã®å¢—æ¸›é¡</td><td class="r ${v>0?"pos":v<0?"neg":""}">${v!==0?fmt(v)+" å††":"â€•"}</td></tr>`;
    });
    html += `<tr class="sub" style="background:${sBg[0]}"><td>å°è¨ˆ</td><td class="r ${opTotal>0?"pos":opTotal<0?"neg":""}">${fmt(opTotal)} å††</td></tr></tbody></table>`;
    // æŠ•è³‡ãƒ»è²¡å‹™CF
    [1,2].forEach(si => {
      html += `<table><thead><tr><th colspan="2" style="background:${sCol[si]}">${sections[si].label}</th></tr></thead><tbody>`;
      sections[si].items.forEach(item => {
        const v = parseNum(values[item.id]) * item.sign;
        html += `<tr><td>${item.label}</td><td class="r ${v>0?"pos":v<0?"neg":""}">${v!==0?fmt(v)+" å††":"â€•"}</td></tr>`;
      });
      const t = sectionTotal(sections[si]);
      html += `<tr class="sub" style="background:${sBg[si]}"><td>å°è¨ˆ</td><td class="r ${t>0?"pos":t<0?"neg":""}">${fmt(t)} å††</td></tr></tbody></table>`;
    });
    html += `<table><thead><tr><th colspan="2" style="background:#374151">â…£ï¼ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜</th></tr></thead><tbody>`;
    html += `<tr><td>æœŸé¦–ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜</td><td class="r">${fmt(parseNum(cashStart))} å††</td></tr>`;
    html += `<tr class="hl"><td>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼å¢—æ¸›é¡åˆè¨ˆ</td><td class="r ${netChange>0?"pos":netChange<0?"neg":""}">${fmt(netChange)} å††</td></tr>`;
    html += `<tr class="fin"><td>æœŸæœ«ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜</td><td class="r ${cashEnd>0?"pos":cashEnd<0?"neg":""}">${fmt(cashEnd)} å††</td></tr></tbody></table>`;
    const sc = score>=80?"#1d4ed8":score>=50?"#ca8a04":"#dc2626";
    html += `<div class="sb"><div style="font-size:11px;color:#6b7280;">ç·åˆã‚¹ã‚³ã‚¢</div>
      <div style="font-size:40px;font-weight:bold;color:${sc}">${score}<span style="font-size:18px;color:#9ca3af">/100</span></div>
      <div style="font-weight:bold;color:${sc}">${score>=80?"å„ªè‰¯ï¼šå¥å…¨ãªè²¡å‹™çŠ¶æ…‹ã§ã™":score>=50?"æ™®é€šï¼šä¸€éƒ¨ã«æ”¹å–„ä½™åœ°ãŒã‚ã‚Šã¾ã™":"è¦æ”¹å–„ï¼šæ—©æ€¥ãªå¯¾ç­–ãŒå¿…è¦ã§ã™"}</div></div>`;
    html += `<h2>â–  çµŒå–¶åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ</h2>`;
    comments.forEach(c => {
      html += `<div class="comment" style="background:${lCol[c.level]};border-color:${lBd[c.level]}"><div class="ct">${c.title}</div><div>${c.body}</div></div>`;
    });
    html += `<script>window.onload=()=>window.print();<\/script></body></html>`;
    w.document.write(html); w.document.close();
  };

  const exportCSV = () => {
    const rows = [];
    rows.push(["ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—æ›¸"],[companyName],[`å¯¾è±¡æœŸé–“ï¼š${period}`],[]);
    rows.push([sections[0].label]);
    sections[0].items.forEach(item => { const v=parseNum(values[item.id])*item.sign; rows.push(["",item.label,v!==0?v:""]); });
    diffItems.forEach(item => { const v=diffResult(item); rows.push(["",`${item.label}ã®å¢—æ¸›é¡`,v!==0?v:""]); });
    rows.push(["","å°è¨ˆ",opTotal],[]);
    [1,2].forEach(si => {
      rows.push([sections[si].label]);
      sections[si].items.forEach(item => { const v=parseNum(values[item.id])*item.sign; rows.push(["",item.label,v!==0?v:""]); });
      rows.push(["","å°è¨ˆ",sectionTotal(sections[si])]); rows.push([]);
    });
    rows.push(["ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼å¢—æ¸›é¡åˆè¨ˆ","",netChange],["æœŸé¦–ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜","",parseNum(cashStart)],["æœŸæœ«ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜","",cashEnd],[]);
    rows.push([`ç·åˆã‚¹ã‚³ã‚¢ï¼š${score}/100`],["â– çµŒå–¶åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ"]);
    comments.forEach(c => rows.push([c.title,c.body]));
    const csv = rows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
    const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`CFè¨ˆç®—æ›¸_${companyName}.csv`; a.click();
  };

  return (
    <div className="max-w-2xl mx-auto p-4 font-sans text-sm">
      <h1 className="text-xl font-bold text-center mb-4 text-gray-800">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¨ˆç®—æ›¸</h1>

      <div className="flex mb-4 border-b">
        {[["input","å…¥åŠ›ãƒ»é›†è¨ˆ"],["analysis","çµŒå–¶åˆ†æ"],["scoring","ã‚¹ã‚³ã‚¢ã®å†…è¨³"]].map(([id,label]) => (
          <button key={id} onClick={()=>setTab(id)}
            className={`px-4 py-2 text-sm font-bold border-b-2 -mb-px ${tab===id?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`}>
            {label}
          </button>
        ))}
      </div>

      {tab === "input" && (
        <>
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="bg-gray-50 border rounded p-3 mb-4 grid grid-cols-2 gap-3">
            <div><label className="block text-xs text-gray-500 mb-1">ä¼šç¤¾å</label>
              <input className="border rounded px-2 py-1 w-full text-sm" value={companyName} onChange={e=>setCompanyName(e.target.value)} /></div>
            <div><label className="block text-xs text-gray-500 mb-1">å¯¾è±¡æœŸé–“</label>
              <input className="border rounded px-2 py-1 w-full text-sm" value={period} onChange={e=>setPeriod(e.target.value)} /></div>
            <div><label className="block text-xs text-gray-500 mb-1">æœˆå•†ï¼ˆåˆ†æç”¨ãƒ»ä»»æ„ï¼‰</label>
              <NumInput value={values.monthly_revenue} onChange={v=>set("monthly_revenue",v)} placeholder="ä¾‹ï¼š10,000,000" /></div>
          </div>

          {/* å–¶æ¥­CF */}
          <div className="mb-4 border rounded overflow-hidden">
            <div className="px-3 py-2 font-bold text-white text-xs bg-blue-600">{sections[0].label}</div>
            <table className="w-full">
              <tbody>
                {sections[0].items.map(item => (
                  <tr key={item.id} className="border-b hover:bg-gray-50">
                    <td className="px-3 py-2 text-gray-700 w-3/5">{item.label}</td>
                    <td className="px-3 py-2 w-2/5"><NumInput value={values[item.id]} onChange={v=>set(item.id,v)} /></td>
                  </tr>
                ))}

                {/* å‰æœŸãƒ»ä»ŠæœŸå…¥åŠ›è¡Œ */}
                {diffItems.map(item => {
                  const diff = diffResult(item);
                  return (
                    <tr key={item.id} className="border-b bg-blue-50">
                      <td className="px-3 py-2" colSpan={2}>
                        <div className="flex items-center gap-1 mb-1">
                          <span className="text-gray-700 font-medium">{item.label}</span>
                          <span className="text-xs text-gray-400">ï¼ˆ{item.hint}ï¼‰</span>
                        </div>
                        <div className="grid grid-cols-3 gap-2 items-center">
                          <div>
                            <div className="text-xs text-gray-500 mb-0.5">å‰æœŸæ®‹é«˜</div>
                            <NumInput value={diffVals[`${item.id}_prev`]} onChange={v=>setDiff(`${item.id}_prev`,v)} placeholder="0" />
                          </div>
                          <div>
                            <div className="text-xs text-gray-500 mb-0.5">ä»ŠæœŸæ®‹é«˜</div>
                            <NumInput value={diffVals[`${item.id}_curr`]} onChange={v=>setDiff(`${item.id}_curr`,v)} placeholder="0" />
                          </div>
                          <div>
                            <div className="text-xs text-gray-500 mb-0.5">å¢—æ¸›é¡ï¼ˆè‡ªå‹•ï¼‰</div>
                            <div className={`border rounded px-2 py-1 text-right text-sm bg-gray-100 ${colorClass(diff)}`}>
                              {fmt(diff)} å††
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  );
                })}

                <tr className="bg-blue-50">
                  <td className="px-3 py-2 font-bold">å°è¨ˆ</td>
                  <td className={`px-3 py-2 text-right font-bold ${colorClass(opTotal)}`}>{fmt(opTotal)} å††</td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* æŠ•è³‡ãƒ»è²¡å‹™CF */}
          {[1,2].map(si => (
            <div key={sections[si].id} className="mb-4 border rounded overflow-hidden">
              <div className={`px-3 py-2 font-bold text-white text-xs ${sections[si].color}`}>{sections[si].label}</div>
              <table className="w-full">
                <tbody>
                  {sections[si].items.map(item => (
                    <tr key={item.id} className="border-b hover:bg-gray-50">
                      <td className="px-3 py-2 text-gray-700 w-3/5">{item.label}</td>
                      <td className="px-3 py-2 w-2/5"><NumInput value={values[item.id]} onChange={v=>set(item.id,v)} /></td>
                    </tr>
                  ))}
                  <tr className={sections[si].bg}>
                    <td className="px-3 py-2 font-bold">å°è¨ˆ</td>
                    <td className={`px-3 py-2 text-right font-bold ${colorClass(sectionTotal(sections[si]))}`}>{fmt(sectionTotal(sections[si]))} å††</td>
                  </tr>
                </tbody>
              </table>
            </div>
          ))}

          {/* æ®‹é«˜ */}
          <div className="border rounded overflow-hidden mb-4">
            <div className="bg-gray-700 px-3 py-2 font-bold text-white text-xs">â…£ï¼ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜</div>
            <table className="w-full">
              <tbody>
                <tr className="border-b">
                  <td className="px-3 py-2 text-gray-700 w-3/5">æœŸé¦–ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜</td>
                  <td className="px-3 py-2 w-2/5"><NumInput value={cashStart} onChange={v=>setCashStart(v)} /></td>
                </tr>
                <tr className="border-b bg-yellow-50">
                  <td className="px-3 py-2 font-bold">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼å¢—æ¸›é¡åˆè¨ˆ</td>
                  <td className={`px-3 py-2 text-right ${colorClass(netChange)}`}>{fmt(netChange)} å††</td>
                </tr>
                <tr className="bg-gray-100">
                  <td className="px-3 py-2 font-bold">æœŸæœ«ç¾é‡‘ãƒ»é é‡‘æ®‹é«˜</td>
                  <td className={`px-3 py-2 text-right ${colorClass(cashEnd)}`}>{fmt(cashEnd)} å††</td>
                </tr>
              </tbody>
            </table>
          </div>

          <button onClick={exportCSV} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-sm">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆExcelå¯¾å¿œï¼‰</button>
          <button onClick={exportPDF} className="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded text-sm">PDFã§å°åˆ·ãƒ»ä¿å­˜ï¼ˆåˆ†æã‚³ãƒ¡ãƒ³ãƒˆå«ã‚€ï¼‰</button>
          <p className="text-xs text-gray-400 text-center mt-2">PDFã¯å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€ŒPDFã¨ã—ã¦ä¿å­˜ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </>
      )}

      {tab === "analysis" && (
        <div>
          <div className="border rounded p-4 mb-5 bg-white shadow-sm text-center">
            <div className="text-xs text-gray-500 mb-1">ç·åˆã‚¹ã‚³ã‚¢</div>
            <div className={`text-5xl font-bold mb-1 ${score>=80?"text-blue-600":score>=50?"text-yellow-500":"text-red-500"}`}>
              {score}<span className="text-2xl text-gray-400">/100</span>
            </div>
            <div className="flex justify-center gap-0.5 mb-2">
              {Array.from({length:20}).map((_,i) => (
                <div key={i} className={`h-3 w-4 rounded-sm ${i<Math.round(score/5)?(score>=80?"bg-blue-500":score>=50?"bg-yellow-400":"bg-red-400"):"bg-gray-200"}`} />
              ))}
            </div>
            <div className={`text-sm font-bold ${score>=80?"text-blue-600":score>=50?"text-yellow-600":"text-red-600"}`}>
              {score>=80?"å„ªè‰¯ï¼šå¥å…¨ãªè²¡å‹™çŠ¶æ…‹ã§ã™":score>=50?"æ™®é€šï¼šä¸€éƒ¨ã«æ”¹å–„ä½™åœ°ãŒã‚ã‚Šã¾ã™":"è¦æ”¹å–„ï¼šæ—©æ€¥ãªå¯¾ç­–ãŒå¿…è¦ã§ã™"}
            </div>
            <div className="text-xs text-gray-400 mt-1">å–¶æ¥­CF(30ç‚¹) ï¼ ãƒ•ãƒªãƒ¼CF(30ç‚¹) ï¼ å£²æ›é‡‘(20ç‚¹) ï¼ åœ¨åº«(10ç‚¹) ï¼ ç¾é‡‘æ®‹é«˜(10ç‚¹)</div>
          </div>

          <div className="border rounded overflow-hidden mb-5">
            <div className="bg-gray-700 px-3 py-2 text-white text-xs font-bold">é …ç›®åˆ¥ã‚¹ã‚³ã‚¢</div>
            <table className="w-full">
              <tbody>
                {breakdown.map(({label,got,max}) => {
                  const pct = max>0?(got/max)*100:0;
                  const bar = pct===100?"bg-blue-500":pct>=50?"bg-yellow-400":"bg-red-400";
                  return (
                    <tr key={label} className="border-b last:border-0">
                      <td className="px-3 py-2 text-gray-700 w-24 whitespace-nowrap">{label}</td>
                      <td className="px-3 py-2 w-full">
                        <div className="flex items-center gap-2">
                          <div className="flex-1 bg-gray-100 rounded-full h-3">
                            <div className={`${bar} h-3 rounded-full`} style={{width:`${pct}%`}} />
                          </div>
                          <span className={`text-sm font-bold whitespace-nowrap w-16 text-right ${pct===100?"text-blue-600":pct>=50?"text-yellow-600":"text-red-500"}`}>
                            {got} / {max}ç‚¹
                          </span>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="grid grid-cols-3 gap-3 mb-5">
            {[{label:"å–¶æ¥­CF",value:opTotal},{label:"ãƒ•ãƒªãƒ¼CF",value:fcf},{label:"æœŸæœ«ç¾é‡‘æ®‹é«˜",value:cashEnd}].map(({label,value}) => (
              <div key={label} className="border rounded p-3 text-center bg-white shadow-sm">
                <div className="text-xs text-gray-500 mb-1">{label}</div>
                <div className={`text-base font-bold ${value>0?"text-blue-600":value<0?"text-red-600":"text-gray-600"}`}>
                  {fmt(value)}<span className="text-xs ml-1">å††</span>
                </div>
              </div>
            ))}
          </div>

          <h2 className="font-bold text-gray-700 mb-3">çµŒå–¶åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ</h2>
          {comments.map((c,i) => {
            const s = levelStyle[c.level];
            return (
              <div key={i} className={`border rounded p-3 mb-3 ${s.bg}`}>
                <div className={`font-bold mb-1 ${s.title}`}>{s.icon} {c.title}</div>
                <div className="text-gray-700 leading-relaxed">{c.body}</div>
              </div>
            );
          })}
          <button onClick={exportPDF} className="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded text-sm">PDFã§å°åˆ·ãƒ»ä¿å­˜ï¼ˆåˆ†æã‚³ãƒ¡ãƒ³ãƒˆå«ã‚€ï¼‰</button>
        </div>
      )}

      {tab === "scoring" && (
        <div>
          <h2 className="font-bold text-gray-700 mb-3">ã‚¹ã‚³ã‚¢ã®å†…è¨³ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰</h2>
          <table className="w-full border rounded overflow-hidden mb-4 text-sm">
            <thead>
              <tr className="bg-gray-700 text-white">
                <th className="px-3 py-2 text-left">é …ç›®</th>
                <th className="px-3 py-2 text-center whitespace-nowrap">ç‚¹æ•°</th>
                <th className="px-3 py-2 text-left">åˆ¤å®šåŸºæº–</th>
              </tr>
            </thead>
            <tbody>
              {scoreBreakdownDef.map((row,ri) =>
                row.rules.map((r,i) => (
                  <tr key={`${ri}-${i}`} className={`border-t ${i===0?"border-gray-300 bg-gray-50":"border-gray-100"}`}>
                    {i===0 && <td className="px-3 py-2 font-bold align-top" rowSpan={row.rules.length}>{row.item}<br/><span className="text-xs text-gray-400 font-normal">æº€ç‚¹ï¼š{row.max}</span></td>}
                    <td className="px-3 py-2 text-center font-bold text-blue-600 whitespace-nowrap">{r.pt}</td>
                    <td className="px-3 py-2 text-gray-600">{r.cond}</td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
          <div className="border rounded p-3 bg-gray-50 text-sm text-gray-600">
            <p className="font-bold mb-2">ç·åˆåˆ¤å®šã®ç›®å®‰</p>
            <div className="flex gap-4">
              <span className="text-blue-600 font-bold">80ç‚¹ä»¥ä¸Šï¼šå„ªè‰¯</span>
              <span className="text-yellow-600 font-bold">50ã€œ79ç‚¹ï¼šæ™®é€š</span>
              <span className="text-red-600 font-bold">49ç‚¹ä»¥ä¸‹ï¼šè¦æ”¹å–„</span>
            </div>
            <p className="mt-2 text-xs text-gray-400">â€»ç¾é‡‘æ®‹é«˜ã®ã‚¹ã‚³ã‚¢ã¯æœˆå•†ã‚’å…¥åŠ›ã—ãŸå ´åˆã«åæ˜ ã•ã‚Œã¾ã™</p>
          </div>
        </div>
      )}
    </div>
  );
}
